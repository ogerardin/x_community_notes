FROM golang:1.26-alpine AS builder

WORKDIR /src

# Copy Go module files and download dependencies
COPY cmd/api/go.mod cmd/api/go.sum ./
RUN go mod download

# Build the API server
COPY cmd/api/*.go ./
COPY cmd/api/migrations/ ./migrations/
RUN CGO_ENABLED=0 GOOS=linux go build -o api-server

# Final stage
FROM postgres:17-alpine

ENV POSTGRES_PASSWORD=example
ENV POSTGREST_VERSION=14.3
ENV HOMEDIR=/home

RUN apk add --no-cache curl nginx unzip

WORKDIR ${HOMEDIR}

# Add SQL files to initialize the database
# Postgres will automatically run these scripts on startup if the database is empty
COPY sql/*.sql /docker-entrypoint-initdb.d/

# Install PostgREST
ADD https://github.com/PostgREST/postgrest/releases/download/v${POSTGREST_VERSION}/postgrest-v${POSTGREST_VERSION}-linux-static-x86-64.tar.xz .
RUN tar -xf postgrest-v${POSTGREST_VERSION}-linux-static-x86-64.tar.xz \
    && mv postgrest /usr/local/bin/ \
    && rm postgrest-v${POSTGREST_VERSION}-linux-static-x86-64.tar.xz \
    && chmod +x /usr/local/bin/postgrest

# Generate the PostgREST configuration file
COPY <<EOF postgrest.conf
db-uri = "postgres://postgres:$POSTGRES_PASSWORD@localhost:5432/postgres"
db-anon-role = "postgres"
db-aggregates-enabled = true
EOF

# Add the static files for the web interface
COPY www/* ./www/

# Generate the Nginx configuration file
COPY <<EOF nginx.conf
events {}
http {
    server {
        listen 80;
        root ${HOMEDIR}/www;
        index index.html;
        location / {
            try_files \$uri \$uri/ /admin.html;
            add_header Cache-Control "no-store";
        }
        location /admin.html {
            add_header Cache-Control "no-store";
        }
        location /api/imports/current {
            proxy_pass http://127.0.0.1:3000/import_history?order=started_at.desc&limit=1;
        }
        location /api/imports/create {
            proxy_pass http://127.0.0.1:8888/imports;
        }
        location /api/imports/ {
            proxy_pass http://127.0.0.1:8888/imports/;
        }
        location /api/imports {
            proxy_pass http://127.0.0.1:3000/import_history?order=started_at.desc&limit=50;
        }
        location /health {
            proxy_pass http://127.0.0.1:8888/health;
        }
        location /api/ {
            proxy_pass http://127.0.0.1:3000/;
        }
    }
}
EOF


# Copy the API server binary from builder
COPY --from=builder /src/api-server /usr/local/bin/

# Import can be triggered via API: curl -X POST http://localhost:8080/api/imports

# Data directory for downloaded notes
VOLUME ["$HOMEDIR/data"]


# Create a script to serve as entrypoint to start all services
# The script starts cron, Postgres, PostgREST, Nginx, and the API server
COPY <<EOF run.sh
/usr/sbin/crond -L /var/log/crond.log &
/usr/local/bin/docker-entrypoint.sh postgres &
until pg_isready -q; do sleep 1; done
/usr/local/bin/postgrest ${HOMEDIR}/postgrest.conf &
/usr/local/bin/api-server &
nginx -c ${HOMEDIR}/nginx.conf -g "daemon off;"
EOF

ENTRYPOINT ["/bin/sh", "run.sh"]

# Expose main port (web interface and API)
EXPOSE 80
# Expose Postgres port if you need to connect directly to the database
EXPOSE 5432

