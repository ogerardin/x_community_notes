# Build stage
FROM ogerardin/x-notes-builder AS builder
ARG VERSION
ARG GIT_SHA
ARG BUILD_TIME

# Final stage
FROM postgres:18.3-alpine

ARG VERSION
ARG GIT_SHA
ARG BUILD_TIME
ARG REPOSITORY

LABEL org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.source="${REPOSITORY}" \
      org.opencontainers.image.revision="${GIT_SHA}" \
      org.opencontainers.image.created="${BUILD_TIME}"

ENV API_VERSION=${VERSION}
ENV API_GIT_SHA=${GIT_SHA}
ENV API_BUILD_TIME=${BUILD_TIME}

ARG POSTGRES_HOST_AUTH_METHOD=trust
ENV POSTGRES_HOST_AUTH_METHOD=${POSTGRES_HOST_AUTH_METHOD}
ENV POSTGREST_VERSION=14.5
ENV HOMEDIR=/home

RUN apk add --no-cache curl nginx unzip

WORKDIR ${HOMEDIR}

# Add SQL files to initialize the database
# Postgres will automatically run these scripts on startup if the database is empty
COPY sql/*.sql /docker-entrypoint-initdb.d/

# Install PostgREST
ADD https://github.com/PostgREST/postgrest/releases/download/v${POSTGREST_VERSION}/postgrest-v${POSTGREST_VERSION}-linux-static-x86-64.tar.xz .
RUN tar -xf postgrest-v${POSTGREST_VERSION}-linux-static-x86-64.tar.xz \
    && mv postgrest /usr/local/bin/ \
    && rm postgrest-v${POSTGREST_VERSION}-linux-static-x86-64.tar.xz \
    && chmod +x /usr/local/bin/postgrest

# Generate the PostgREST configuration file
COPY <<EOF postgrest.conf
db-uri = "postgres://postgres@localhost:5432/postgres"
db-anon-role = "postgres"
db-aggregates-enabled = true
db-pool = 20
db-pool-max = 20
db-pool-min = 5
EOF

# Add the static files for the web interface
COPY www/* ./www/

# Generate the Nginx configuration file from template
COPY nginx.conf.template ./nginx.conf.template
RUN sed -e 's/__POSTGREST__/127.0.0.1/g' -e 's/__API__/127.0.0.1/g' nginx.conf.template > nginx.conf && \
    grep -q "127.0.0.1:3000" nginx.conf && rm nginx.conf.template


# Copy the API server binary from builder
COPY --from=builder /src/api-server /usr/local/bin/

# Import can be triggered via API: curl -X POST http://localhost:8080/api/imports

# Data directory for downloaded notes
VOLUME ["$HOMEDIR/data"]


# Create a script to serve as entrypoint to start all services
# The script starts cron, Postgres, PostgREST, Nginx, and the API server
COPY <<EOF run.sh
/usr/sbin/crond -L /var/log/crond.log &
/usr/local/bin/docker-entrypoint.sh postgres &
until pg_isready -q; do sleep 1; done
/usr/local/bin/postgrest ${HOMEDIR}/postgrest.conf &
/usr/local/bin/api-server &
nginx -c ${HOMEDIR}/nginx.conf -g "daemon off;"
EOF

ENTRYPOINT ["/bin/sh", "run.sh"]

# Expose main port (web interface and API)
EXPOSE 80
# Expose Postgres port if you need to connect directly to the database
EXPOSE 5432

