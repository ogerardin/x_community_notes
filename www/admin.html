<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Note Search</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 1em;
        }
        h1 {
            margin-top: 0;
            font-size: 1.5em;
        }
        .nav-link {
            font-size: 0.9em;
            color: #007bff;
            text-decoration: none;
        }
        .nav-link:hover {
            text-decoration: underline;
        }
        .info-row {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 1em;
            display: flex;
            align-items: center;
            gap: 1em;
        }
        .import-btn:disabled {
            background: #6c757d !important;
            cursor: not-allowed;
        }
        .import-btn {
            padding: 0.5em 1em;
            font-size: 1em;
            cursor: pointer;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .import-btn:hover {
            background: #218838;
        }
        .import-status {
            font-size: 0.9em;
        }
        .error {
            color: #dc3545;
            margin-bottom: 0.5em;
        }
        .refresh-btn {
            padding: 2px 8px;
            font-size: 0.9em;
            cursor: pointer;
            background: #f4f4f4;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .history-section {
            margin-top: 2em;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            margin-top: 0.5em;
        }
        .history-table th, .history-table td {
            border: 1px solid #ccc;
            padding: 0.5em;
            text-align: left;
        }
        .history-table th {
            background: #f4f4f4;
        }
        .status-completed { color: #28a745; }
        .status-failed { color: #dc3545; }
        .status-importing { color: #007bff; }
        .status-downloading { color: #007bff; }
        .status-idle { color: #666; }
        .progress-cell {
        }
        .progress-cell.active {
            color: #007bff;
        }

        @media (max-width: 480px) {
            body {
                padding: 0.25em;
            }
            h1 {
                font-size: 1.1em;
            }
            .info-row {
                font-size: 0.8em;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
<h1>Admin <a href="/index.html" class="nav-link" style="font-size: 0.6em; margin-left: 1em;">Search</a></h1>

<div x-data="{
        noteCount: 0,
        latestTimestamp: null,
        importStatus: null,
        importError: '',
        backendOnline: true,
        importPollInterval: null,
        importHistory: [],
        formatDuration(seconds) {
            if (seconds === null || seconds === undefined) return '';
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return m > 0 ? (s > 0 ? m + 'm ' + s + 's' : m + 'm') : s + 's';
        },
        formatFileSize(bytes) {
            if (bytes === null || bytes === undefined) return '';
            if (bytes >= 1e9) return (bytes / 1e9).toFixed(1) + ' GB';
            if (bytes >= 1e6) return Math.round(bytes / 1e6) + ' MB';
            return Math.round(bytes / 1e3) + ' KB';
        },
        calculateRemaining(rowsProcessed, totalRows, duration) {
            if (!rowsProcessed || !totalRows || !duration) return '';
            const rate = rowsProcessed / duration;
            const remaining = totalRows - rowsProcessed;
            const remainingSeconds = Math.round(remaining / rate);
            return this.formatDuration(remainingSeconds);
        },
        calculateDownloadRemaining(bytesRead, totalBytes, duration) {
            if (!bytesRead || !totalBytes || !duration) return '';
            const rate = bytesRead / duration;
            const remaining = totalBytes - bytesRead;
            return this.formatDuration(Math.round(remaining / rate));
        },
        async refreshNoteStats() {
            try {
                let resp = await fetch('/api/note?select=summary.count()');
                let data = await resp.json();
                this.noteCount = data[0]?.count ?? 0;
                
                resp = await fetch('/api/note?select=createdatmillis.max()');
                data = await resp.json();
                this.latestTimestamp = data[0]?.max ?? 0;
            } catch (e) {
                console.error('Failed to fetch note stats:', e);
            }
        },
        async fetchImportStatus() {
            try {
                let resp = await fetch('/api/imports/current');
                if (!resp.ok) throw new Error('Failed to fetch import status');
                let data = await resp.json();
                this.importStatus = Array.isArray(data) ? (data[0] ?? null) : data;
                this.importError = '';
                this.backendOnline = true;
                this.fetchImportHistory();
                if (this.importStatus?.status === 'importing' || this.importStatus?.status === 'downloading') {
                    this.startPolling();
                } else {
                    this.stopPolling();
                }
            } catch (e) {
                this.backendOnline = false;
                this.importError = '';
            }
        },
        async fetchImportHistory() {
            try {
                let resp = await fetch('/api/imports');
                if (!resp.ok) throw new Error('Failed to fetch import history');
                this.importHistory = await resp.json() || [];
            } catch (e) {
                console.error('Failed to fetch import history:', e);
            }
        },
        async triggerImport() {
            try {
                this.importError = '';
                if (this.importStatus?.status === 'importing' || this.importStatus?.status === 'downloading') {
                    this.importError = 'Import already in progress';
                    return;
                }
                let resp = await fetch('/api/imports/create', { method: 'POST' });
                if (!resp.ok) throw new Error('Failed to trigger import: ' + resp.status);
                await this.fetchImportStatus();
                await this.fetchImportHistory();
            } catch (e) {
                this.importError = e.message;
            }
        },
        async abortImport() {
            try {
                if (!this.importStatus?.job_id) return;
                let resp = await fetch('/api/imports/' + this.importStatus.job_id, { method: 'DELETE' });
                if (!resp.ok) throw new Error('Failed to abort import');
                await this.fetchImportStatus();
                await this.fetchImportHistory();
            } catch (e) {
                this.importError = e.message;
            }
        },
        startPolling() {
            if (this.importPollInterval) return;
            this.importPollInterval = setInterval(() => {
                this.fetchImportStatus();
                this.fetchImportHistory();
                this.refreshNoteStats();
            }, 2000);
        },
        stopPolling() {
            if (this.importPollInterval) {
                clearInterval(this.importPollInterval);
                this.importPollInterval = null;
            }
        },
        init() {
            this.fetchImportStatus();
            this.refreshNoteStats();
            this.fetchImportHistory();
            setInterval(() => this.fetchImportStatus(), 5000);
        },

    }">

    <div x-show="!backendOnline" style="background: #dc3545; color: white; padding: 0.5em 1em; margin-bottom: 1em; border-radius: 4px;">
        Backend unavailable
    </div>

    <div class="info-row">
        <span x-text="noteCount.toLocaleString() + ' notes, latest: ' + (latestTimestamp ? new Date(latestTimestamp).toLocaleString() : 'N/A')"></span>
        <button @click="refreshNoteStats(); fetchImportHistory();" class="refresh-btn">Refresh</button>
    </div>

    <div class="import-bar" style="margin-bottom: 1em;">
        <button
            class="import-btn"
            @click="triggerImport()"
            x-bind:disabled="importStatus?.status === 'importing' || importStatus?.status === 'downloading'"
        >
            Update Notes
        </button>
        <button
            class="import-btn"
            style="background: #dc3545; margin-left: 0.5em;"
            @click="abortImport()"
            x-show="importStatus?.status === 'importing' || importStatus?.status === 'downloading'"
        >
            Abort
        </button>
        <span x-show="importError" class="error" style="margin-left: 1em;" x-text="importError"></span>
    </div>

    <div class="history-section">
        <h2 style="font-size: 1.2em; margin-bottom: 0.5em;">Import History</h2>
        <table class="history-table">
            <thead>
                <tr>
                    <th>Started</th>
                    <th>Completed</th>
                    <th>Files</th>
                    <th>Status</th>
                    <th>Download progress</th>
                    <th>Import progress</th>
                    <th>Error</th>
                </tr>
            </thead>
            <tbody x-show="importHistory.length > 0">
                <template x-for="h in importHistory" :key="h.id">
                    <tr>
                        <td x-text="new Date(h.started_at).toLocaleString()"></td>
                        <td x-text="h.status === 'completed' && h.completed_at ? new Date(h.completed_at).toLocaleString() : '-'"></td>
                        <td>
                            <template x-if="h.file_names">
                                <div style="display: flex; flex-direction: column;">
                                    <template x-for="f in h.file_names.split(',')" :key="f">
                                        <span x-text="f"></span>
                                    </template>
                                </div>
                            </template>
                            <span x-show="!h.file_names">-</span>
                        </td>
                        <td>
                            <span :class="'status-' + h.status" x-text="h.status"></span>
                        </td>
                        <td>
                            <template x-if="h.status === 'downloading'">
                                <span class="progress-cell active" x-text="(h.current_file_index ?? 0) + 1 + ' / ' + (h.total_files ?? 0) + ' - ' + (h.download_percentage ?? 0) + '% ' + (h.download_speed ?? '')"></span>
                            </template>
                            <template x-if="h.status === 'importing' && h.download_cached">
                                <span class="progress-cell" x-text="(h.total_files ?? 0) + ' files, ' + formatFileSize(h.file_size) + ' (cached)'"></span>
                            </template>
                            <template x-if="h.status === 'importing' && !h.download_cached">
                                <span class="progress-cell" x-text="(h.total_files ?? 0) + ' files, ' + formatFileSize(h.file_size) + ' in ' + formatDuration(h.download_duration)"></span>
                            </template>
                            <template x-if="h.status === 'completed' && h.download_cached">
                                <span class="progress-cell" x-text="(h.total_files ?? 0) + ' files, ' + formatFileSize(h.file_size) + ' (cached)'"></span>
                            </template>
                            <template x-if="h.status === 'completed' && !h.download_cached">
                                <span class="progress-cell" x-text="(h.total_files ?? 0) + ' files, ' + formatFileSize(h.file_size) + ' in ' + formatDuration(h.download_duration)"></span>
                            </template>
                            <span x-show="h.status === 'failed'" class="progress-cell">-</span>
                        </td>
                        <td>
                            <template x-if="h.status === 'importing'">
                                <span class="progress-cell active" x-text="(h.current_file_index ?? 0) + 1 + '/' + (h.total_files ?? 0) + ' - ' + (h.rows_processed ?? 0).toLocaleString() + ' / ' + (h.total_rows ? h.total_rows.toLocaleString() : '?') + ' (' + (h.total_rows ? Math.round((h.rows_processed ?? 0) / h.total_rows * 100) : 0) + '%)'"></span>
                            </template>
                            <template x-if="h.status === 'completed'">
                                <span class="progress-cell" x-text="(h.total_rows ?? 0).toLocaleString() + ' rows in ' + formatDuration(h.import_duration)"></span>
                            </template>
                            <span x-show="h.status === 'idle' || h.status === 'failed' || h.status === 'downloading'" class="progress-cell">-</span>
                        </td>
                        <td x-text="h.error_message ?? '-'"></td>
                    </tr>
                </template>
            </tbody>
            <tbody x-show="importHistory.length === 0">
                <tr>
                    <td colspan="7" style="color: #666; text-align: center;">No import history</td>
                </tr>
            </tbody>
        </table>
    </div>

</div>
</body>
</html>
